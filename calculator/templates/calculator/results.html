{% extends "base.html" %}
{% load i18n static average %}

{% block title %}Instruments{% endblock %}

{% block content %}

<div class="jumbotron">
  <h1 class="display-4">Results - Stability study "{{ setting.name }}"</h1>
  <p class="lead">This is a simple hero unit, a simple jumbotron-style component for calling extra attention to featured content or information.</p>
  <hr class="my-4">
</div>

    <div class="row ">

{#    -------------------------------DESCRIPTION TABLE -------------------------------#}

    <div class="col">
        <table class="table table-hover">
            <thead class="th_analytical">
            <th>Parameter:</th>
            <td>{{ setting.parameter.name }} ({{ setting.parameter.unit}})</td>
            </thead>


            <tr>
                <th>Instrument:</th>
                <td>{{ setting.parameter.instrument }}</td>
            </tr>
            <tr>
                <th>Reagent:</th>
                <td>{{ setting.parameter.reagent_name }}<br>
                    {{ setting.parameter.reagent_manufacturer}}
                </td>
            </tr>
            <tr>
                <th>Manual method:</th>
                <td>{% if setting.parameter.method_hand == True %}
                    Yes
                    {% else %}
                    No
                    {% endif %}</td>
            </tr>
            <tr>
                <th>Method Intra CV%</th>
                <td>{{ setting.parameter.CV_intra}} %</td>
            </tr>
            <tr>
                <th>Method Inter CV%</th>
                <td>{{ setting.parameter.CV_inter}} %</td>
            </tr>
        </table>
        </div>
    <div class="col">
        <table class="table table-hover">
            <thead>
                <th class="th_condition" colspan="2">Storage Conditions</th>
            </thead>
            <tr>
                <th>Sample</th>
                <td>
                    Sample Type: {{ setting.parameter.sample.get_sample_type_display}} <br>
                    Additive: {{ setting.parameter.sample.get_container_additive_display}}<br>
                    Container: {{ setting.parameter.sample.container_fillingvolume}} mL /
                                {{ setting.parameter.sample.get_container_dimension_display}} /
                                {{ setting.parameter.sample.get_container_material_display}}
                    Seperator (Gel): {% if setting.parameter.sample.gel == True %}
                    Yes
                    {% else %}
                    No
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Temperature</th>
                <td>
                {{ setting.condition.get_temperature_display }}
                </td>
            </tr>
        <tr>
                <th>Other condition</th>
                <td>{{ setting.condition.other_Condition }}</td>
            </tr>
                <tr>
                    <th colspan="2">Exposure during storage to...</th>
                </tr>
            <tr>
                <th>...light</th>
                <td>
                    {% if setting.condition.light == True %}
                    Yes
                    {% else %}
                    No
                    {% endif %}
                    </td>
            </tr>
            <tr>
                <th>...air</th>
                <td>
                    {% if setting.condition.air.light == True %}
                    Yes
                    {% else %}
                    No
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>...agitation</th>
                <td>

                    {% if setting.condition.agitation == True %}
                    Yes
                    {% else %}
                    No
                    {% endif %}
                </td>
            </tr>

        </table>

    </div>
    </div>

<hr class="my-4">



{#    --------------------------------- CHART.JS GRAPHIC AVERAGES + SD ---------------------------#}
<div class="row">
    <div class="col">
    <canvas id="averages_tot" aria-label="Averages Chart" role="img"></canvas>
    </div>
        <div class="col">
        <canvas id="deviation_tot" aria-label="Deviation Chart Total" role="img"></canvas>
    </div>
    <div class="col">
    <canvas id="deviation_single" aria-label="Deviation Chart Single" role="img"></canvas>
    </div>
        <script>
        const ctx1 = document.getElementById('averages_tot');
        const average_tot_chart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: [{% for duration in setting.duration_set.all %} '{{ duration }}', {% endfor %}],
                datasets: [
                    {
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 1)',
                        {#fill: 'origin',#}
                        borderWidth: 5,
                        borderCapStyle: 'round',
                        borderJoinStyle: 'round',
                        itemRadius: 10,
                        spanGaps: true,
                        label: 'Averages at selected timepoints',
                    data: [
                        {% for duration in setting.duration_set.all %} {% average_tot setting duration %},
                {% endfor %}],

                },
                {
                    type: 'line',
                    label: '+SD',
                    spanGaps: true,
                    data: [{% for duration in setting.duration_set.all %} {% avg_tot_sd_h setting duration %},
                {% endfor %}],
                },
                {
                    type: 'line',
                    label: '-SD',
                    spanGaps: true,
                    data: [{% for duration in setting.duration_set.all %} {% avg_tot_sd_l setting duration %},
                {% endfor %}],
                }]

            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            text: ['lalalal'],
                        }
                    }
                }
            }
        });


        const ctx2 = document.getElementById('deviation_tot');
        const deviation_tot_chart = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: [{% for duration in setting.duration_set.all %} '{{ duration }}', {% endfor %}],
                datasets: [
                    {
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 1)',
                        {#fill: 'origin',#}
                        borderWidth: 5,
                        borderCapStyle: 'round',
                        borderJoinStyle: 'round',
                        itemRadius: 10,
                        spanGaps: true,
                        label: 'Deviation from baseline',
                    data: [
                        {% for duration in setting.duration_set.all %} {% deviation_tot setting duration %},
                {% endfor %}],

                },
                ]

            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            text: ['lalalal'],
                        }
                    }
                }
            }
        });


        const ctx3 = document.getElementById('deviation_single');
        const deviation_tot_single = new Chart(ctx3, {
            type: 'line',
            data: {
                labels: [{% for duration in setting.duration_set.all %} '{{ duration }}', {% endfor %}],
                datasets: [
                    {
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 1)',
                        {#fill: 'origin',#}
                        borderWidth: 5,
                        borderCapStyle: 'round',
                        borderJoinStyle: 'round',
                        itemRadius: 10,
                        spanGaps: true,
                        label: 'Deviation from baseline',
                    data: [
                        {% for duration in setting.duration_set.all %}
                            {% for replicate in subject.replicate_set.all %}
                                {% for result in replicate.result_set.all %}

                            {% deviation setting duration %},

                                    {% endfor %}
                       {% endfor %}
                {% endfor %}],

                },
                ]

            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            text: ['lalalal'],
                        }
                    }
                }
            }
        });
    </script>

    <hr class="my-4">

    </div>

{#    ----------------------------------Google Charts ---------------------------------------#}


    <hr>
    lalala
    <div id="visualization"></div>
    <button id="button_results_total" ></button>
    <script>
    google.charts.load('current', {'packages':['corechart']});
          google.charts.setOnLoadCallback(drawExample2);

          function drawExample2() {
              var rowData1 = [['Timepoint', 'Average Result (relative)'],
                  {% for duration in setting.duration_set.all %}
               ['{{ duration }}', {% deviation_tot setting duration %}],
           {% endfor %}];

              var rowData2 = [['Timepoint', 'Average Result (absolute)'],
                  {% for duration in setting.duration_set.all %}
               ['{{ duration }}', {% average_tot setting duration %}],
           {% endfor %}];

              // Create and populate the data tables.
              var data = [];
              data[0] = google.visualization.arrayToDataTable(rowData1);
              data[1] = google.visualization.arrayToDataTable(rowData2);

              var options = {
                  {#width: 600,#}
                  {#height: 240,#}
                  vAxis: {title: "abs/rel Value"},
                  hAxis: {title: "Storage duration"},
                  seriesType: "line",
                  curveType: 'function',
                  legend: { position: 'bottom' },
                  {#series: {5: {type: "line"}},#}
                  animation: {
                      duration: 1000,
                      easing: 'out'
                  },
              };
              var current = 0;
              // Create and draw the visualization.
              var chart = new google.visualization.ComboChart(document.getElementById('visualization'));
              var button = document.getElementById('button_results_total');

              function drawChart() {
                  // Disabling the button while the chart is drawing.
                  button.disabled = true;
                  google.visualization.events.addListener(chart, 'ready',
                      function () {
                          button.disabled = false;
                          button.value = 'Switch to ' + (current ?  'Absolute' : 'Relative');
                      });
                  options['title'] = (current ? 'ABSOLUTE' : 'RELATIVE') + ' deviation of testresults from baseline';

                  chart.draw(data[current], options);
              }

              drawChart();

              button.onclick = function () {
                  current = 1 - current;
                  drawChart();
              }
          }
    </script>
    <hr>
{#    ---------------------------------Line chart - Total average absolute---------------------------------#}
    <div id="curve_chart" style="width:400; height:300"></div>

    <script type="text/javascript">
          google.charts.load('current', {'packages':['corechart']});
          google.charts.setOnLoadCallback(drawChart);

          function drawChart() {
            var data = google.visualization.arrayToDataTable([
              ['Timepoint', 'Avg Result'],
              {% for duration in setting.duration_set.all %}
               ['{{ duration }}', {% average_tot setting duration %}],
           {% endfor %}
            ]);

            var options = {
              title: 'Overall Average Stability',
              curveType: 'function',
              legend: { position: 'bottom' }
            };

            var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

            chart.draw(data, options);
          }
        </script>

    <hr>
{#    ------------------------------------Multiline-Chart for each individual subject - absolute number----------------------------#}
    <div id="curve_chart_new" style="width:400; height:300"></div>
        <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
        var data = google.visualization.arrayToDataTable([
            [
                'Storage Duration',
                {% for subject in subjects %}
                    '{{ subject }}',
                {% endfor %}
            ],
            {% for duration in setting.duration_set.all %}
                [
                    '{{ duration }}',
                    {% for subject in subjects %}
                        {% average subject duration %},
                        {% endfor %}
                ],
            {% endfor %}
          {#['Year', 'Sales', 'Expenses'],#}
          {#['2004',  1000,      400],#}
          {#['2005',  1170,      460],#}
          {#['2006',  660,       1120],#}
          {#['2007',  1030,      540]#}
        ]);

        var options = {
          title: 'Storage Results (absolute)',
          curveType: 'function',
          legend: { position: 'bottom' },
            interpolateNulls: true,
        };

        var chart = new google.visualization.LineChart(document.getElementById('curve_chart_new'));

        chart.draw(data, options);
      }
    </script>

{#    ----------------------------------Statistics------------------------------------------#}

    <hr>
        Linear regression equation: {{ reg_eq_lin }}<br>
    y...Testresult (dependent variable) <br>
    x1...Timepoint (independent variable) <br>
    <hr>
    Slope: {{ slope | floatformat:5 }}<br>
    Intercept: {{ intercept | floatformat:5}}<br>
    F-value: {{ f_value | floatformat:5}}<br>
    F p-Value: {{ f_p_value | floatformat:5}}<br>

    <hr>

{#    ----------------------------------CALCULATE INDIVIDUAL VALUE--------------------------------------#}

<div class="row">
<div class="col">
    Calculate individual values based on the regression equation: <br>
    Insert staorage duration in seconds: <input type="number" id="calc_input">
{#    TODO: Check if input is in seconds#}
        <button id="button_calc" value="here goes result" onclick="calcValue()">Calculate</button>
    <br>
    The estimated Result at that timepoint is: <p id="calc_result"></p>


    <script>
function calcValue() {
  var x = document.getElementById("calc_input").value;
    var y = {{ intercept }} + x * {{ slope }};
  document.getElementById("calc_result").innerHTML = y;
}
</script>

</div>
</div>

{#    ---------------------------------MODAL - EXTENDED STATISTICS ------------------------------------#}

    <!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#statisticsModal">
  Extended Statistics
</button>

<!-- Modal -->
<div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statisticsModalLabel">Stability study "{{ setting.name }}" <br> Extended Statistics</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
            <pre style="font-family: monospace, monospace">{{ statistics_extended|safe }}</pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
    <hr>
{#    --------------------------------BUTTONS--------------------------------#}
    <div class="row">
    <div class="col">
        <button type="button" class="btn btn-primary" href="{% url 'add_results' %}">Add Result</button>
    </div>
        <div class="col">
        <button type="button" class="btn btn-primary" href="{% url 'add_results' %}">Print</button>
    </div>
        <div class="col">
        <button type="button" class="btn btn-primary" href="{% url 'add_results' %}">Export</button>
    </div>
    </div>

    <hr class="my-4">

{#    ---------------------------------RESULT TABLE------------------------------#}
    <div class="row">
<div class="col">
        <table class="table table-hover">
            <thead class="th_results">
            <tr>
                <th scope="col">Subject</th>
                {% for duration in setting.duration_set.all %}
                    <th>{{ duration.seconds | human_readable_seconds }}</th>
                {% endfor %}

            </tr>
            </thead>
            <tbody>
              <tr class="total_results">
                <td>No of subjects: {{ subjects.count }}</td>
                {% for duration in setting.duration_set.all %}
                    <td>
                    <br>
                        AVG Total: {% average_tot setting duration %} {{ setting.parameter.unit}}<br>
                        SD Total:  {% stdv_tot setting duration %} <br>
                        CV Total:  {% cv_tot setting duration %} %<br>
                        Dev Total:  {% deviation_tot setting duration %} %
                    </td>
                {% endfor %}
            </tr>
            {% for subject in subjects %}

                <tr>
                    <th scope="row" rowspan="2">{{ subject }}</th>
                    {% for duration in setting.duration_set.all %}
                        <td>

                            {% for replicate in subject.replicate_set.all %}
                                {% for result in replicate.result_set.all %}
                                    {% if result.duration == duration %}
                                        {% if result.subject == subject %}
                                            {% if not result.value %}
{# FIXME: Does not work  #}                     'No results entered'
                                                {% else %}
                                        {{ result.value }} {{ setting.parameter.unit }} <br>
                                                {% endif %}
                                    {% endif %}

                                    {% endif %}
                                {% endfor %}
                            {% endfor %}

                        </td>
                    {% endfor %}
                </tr>
                <tr>

                    {% for duration in setting.duration_set.all %}
                <td>
                            AVG: {% average subject duration %} {{ setting.parameter.unit}}<br>
                            SD: {% stdv subject duration %}<br>
                            CV: {% cv subject duration %}%<br>
                            DEV: {% deviation subject duration %}%<br>

                    </td>
                    {% endfor %}

                    <td></td>
                </tr>
            {% endfor %}

            </tbody>



        </table>





</div>

</div>

{#    -----------------------------Loading Bokeh Script ---------------------------------#}


{% endblock %}