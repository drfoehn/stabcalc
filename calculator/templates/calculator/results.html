{% extends "base.html" %}
{% load i18n static average %}

{% block title %}Results - Stability study "{{ setting.name }}"{% endblock %}

{% block content %}

    <div class="jumbotron">
        <h1 class="display-4">Results - Stability study "{{ setting.name }}"</h1>
        <p class="lead">This is a simple hero unit, a simple jumbotron-style component for calling extra attention to
            featured content or information.</p>
        <hr class="my-4">
    </div>
    {#    --------------------------------BUTTONS--------------------------------#}
    <div class="row">
        <div class="col d-flex justify-content-end">
            <a href="#" class="bi bi-printer result_buttons"></a>
            <a href="{{ export_data_excel }}" class="bi bi-box-arrow-down result_buttons"></a>
            <a href="{% url 'create-result' setting.pk %}" class="bi bi-plus-circle result_buttons"></a>

        </div>
    </div>
    <hr class="my-4">

    {#    -------------------------------DESCRIPTION TABLE -------------------------------#}
    <div class="row ">

        <div class="col">
            <table class="table table-hover">
                <thead class="th_analytical">
                <th>Parameter:</th>
                <td>{{ setting.parameter.name }} ({{ setting.parameter.unit }})</td>
                </thead>


                <tr>
                    <th>Instrument:</th>
                    <td>{{ setting.parameter.instrument }}</td>
                </tr>
                <tr>
                    <th>Reagent:</th>
                    <td>{{ setting.parameter.reagent_name }}<br>
                        {{ setting.parameter.reagent_manufacturer }}
                    </td>
                </tr>
                <tr>
                    <th>Manual method:</th>
                    <td>{% if setting.parameter.method_hand == True %}
                        Yes
                    {% else %}
                        No
                    {% endif %}</td>
                </tr>
                <tr>
                    <th>Method Intra CV%</th>
                    <td>{{ setting.parameter.CV_intra }} %</td>
                </tr>
                <tr>
                    <th>Method Inter CV%</th>
                    <td>{{ setting.parameter.CV_inter }} %</td>
                </tr>
            </table>
        </div>
        <div class="col">
            <table class="table table-hover">
                <thead>
                <th class="th_condition" colspan="2">Storage Conditions</th>
                </thead>
                <tr>
                    <th>Sample</th>
                    <td>
                        Sample Type: {{ setting.parameter.sample.get_sample_type_display }} <br>
                        Additive: {{ setting.parameter.sample.get_container_additive_display }}<br>
                        Container: {{ setting.parameter.sample.container_fillingvolume }} mL /
                        {{ setting.parameter.sample.get_container_dimension_display }} /
                        {{ setting.parameter.sample.get_container_material_display }}
                        Seperator (Gel): {% if setting.parameter.sample.gel == True %}
                        Yes
                    {% else %}
                        No
                    {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Temperature</th>
                    <td>
                        {{ setting.condition.get_temperature_display }}
                    </td>
                </tr>
                <tr>
                    <th>Other condition</th>
                    <td>{{ setting.condition.other_condition }}</td>
                </tr>
                <tr>
                    <th colspan="2">Exposure during storage to...</th>
                </tr>
                <tr>
                    <th>...light</th>
                    <td>
                        {% if setting.condition.light == True %}
                            Yes
                        {% else %}
                            No
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>...air</th>
                    <td>
                        {% if setting.condition.air.light == True %}
                            Yes
                        {% else %}
                            No
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>...agitation</th>
                    <td>

                        {% if setting.condition.agitation == True %}
                            Yes
                        {% else %}
                            No
                        {% endif %}
                    </td>
                </tr>

            </table>

        </div>
    </div>

    <hr class="my-4">


    {#    -----------------------------------Interpretation--------------------------------#}
    <h1 class="display-6">Interpretation</h1>

    <br>
    {{ interpretation_dist }} <br>
    The model fitting best to your data is {{ best_fit_model }}, explaining {{ best_fit }} of the variability observed in the storage duration.<br>
    The prediction value of this equation is ............... <br>
    Valid for linear model only: {{ interpretation_1 }}
    <br>
    <br>
    <hr class="my-4">


    {#-----------------------------------------OVERALL STATISTICS-----------------------------------------#}
    <p class="graph_heading">Data</p>
    Number of Subjects: {{ subjects_n }}<br>
{#    FIXME: Number of subjects#}
    Number of tested storage durations: {{ timepoints_n }}<br>
    <br>
    Rainbow-Test: F: {{ rainbow_f | floatformat:3 }} / p: {{ rainbow_p | floatformat:3 }}<br>
    Lillieforsâ€™ test (Kolmogorov - Smirnov test with estimated parameters):
    {{ ksstat | floatformat:3 }} / p: {{ ksstat_p | floatformat:3 }}
    <br>

    <hr class="my-4">

    {#    ----------------------------------Google Charts ---------------------------------------#}

    {#--------------------------------------Switch Graph Total Values------------------------------#}
    <div class="row">
        <div class="col-6">

            <p class="graph_heading">Overall Results</p>
            <div id="visualization"></div>
            <button id="button_results_total" class="btn btn-outline-primary"
            <p id="button_switch"></p></button>
            <script>
                google.charts.load('current', {'packages': ['corechart']});
                google.charts.setOnLoadCallback(drawTotal);

                function drawTotal() {
                    var rowData1 = [['Timepoint', 'Average Result (relative)'],
                        {% for duration in setting.duration.all %}
                            ['{{ duration }}', {% deviation_tot setting duration %}],
                        {% endfor %}];

                    var rowData2 = [['Timepoint', 'Average Result (absolute)'],
                        {% for duration in setting.duration.all %}
                            ['{{ duration }}', {% average_tot setting duration %}],
                        {% endfor %}];

                    // Create and populate the data tables.
                    var data = [];
                    data[0] = google.visualization.arrayToDataTable(rowData1);
                    data[1] = google.visualization.arrayToDataTable(rowData2);

                    var options = {
                        {#width: 600,#}
                        {#height: 240,#}
                        vAxis: {title: "abs/rel Value"},
                        hAxis: {title: "Storage duration"},
                        seriesType: "line",
                        curveType: 'function',
                        legend: {position: 'top'},
                        interpolateNulls: true,
                        {#series: {5: {type: "line"}},#}
                        animation: {
                            duration: 1000,
                            easing: 'out'
                        },
                    };
                    var current = 0;
                    // Create and draw the visualization.
                    var chart = new google.visualization.ComboChart(document.getElementById('visualization'));
                    var button = document.getElementById('button_results_total');

                    function drawChart() {
                        // Disabling the button while the chart is drawing.
                        button.disabled = true;
                        google.visualization.events.addListener(chart, 'ready',
                            function () {
                                button.disabled = false;
                                button.value = 'Switch to ' + (current ? 'Relative' : 'Absolute');
                                button.innerHTML = button.value
                            });

                        options['title'] = (current ? 'ABSOLUTE' : 'RELATIVE') + ' deviation of testresults from baseline';

                        chart.draw(data[current], options);
                    }

                    drawChart();

                    button.onclick = function () {
                        current = 1 - current;
                        drawChart();
                    }
                }
            </script>


            {#    ---------------------------------------Switch Graph Single Values---------------------------------------#}

        </div>
        <div class="col-6">
            <p class="graph_heading">Single Results</p>
            <div id="visualization_single"></div>
            <button id="button_results_single" class="btn btn-outline-primary"><p id="button_switch_single"></p>
            </button>
            <script>
                google.charts.load('current', {'packages': ['corechart']});
                google.charts.setOnLoadCallback(drawSingle);

                function drawSingle() {
                    var rowData1 =
                        [[
                            'Storage Duration',
                            {% for subject in subjects %}
                                '{{ subject }}',
                            {% endfor %}
                        ],
                            {% for duration in setting.duration.all %}

                                [
                                    '{{ duration }}',
                                    {% for subject in subjects %}
                                        {% deviation subject duration setting %},
                                    {% endfor %}
                                ],

                            {% endfor %}];


                    var rowData2 = [[
                        'Storage Duration',
                        {% for subject in subjects %}
                            '{{ subject }}',
                        {% endfor %}
                    ],
                        {% for duration in setting.duration.all %}

                            [
                                '{{ duration }}',
                                {% for subject in subjects %}
                                    {% average subject duration setting %},
                                {% endfor %}
                            ],

                        {% endfor %}];

                    // Create and populate the data tables.
                    var data = [];
                    data[0] = google.visualization.arrayToDataTable(rowData1);
                    data[1] = google.visualization.arrayToDataTable(rowData2);

                    var options = {
                        {#width: 600,#}
                        {#height: 240,#}
                        vAxis: {title: "abs/rel Value"},
                        hAxis: {title: "Storage duration"},
                        seriesType: "line",
                        curveType: 'function',
                        legend: {position: 'top'},
                        interpolateNulls: true,
                        {#series: {5: {type: "line"}},#}
                        animation: {
                            duration: 1000,
                            easing: 'out'
                        },
                    };
                    var current = 0;
                    // Create and draw the visualization.
                    var chart = new google.visualization.ComboChart(document.getElementById('visualization_single'));
                    var button = document.getElementById('button_results_single');

                    function drawChart() {
                        // Disabling the button while the chart is drawing.
                        button.disabled = true;
                        google.visualization.events.addListener(chart, 'ready',
                            function () {
                                button.disabled = false;
                                button.value = 'Switch to ' + (current ? 'Relative' : 'Absolute');
                                button.innerHTML = button.value
                            });

                        options['title'] = (current ? 'ABSOLUTE' : 'RELATIVE') + ' deviation of testresults from baseline';

                        chart.draw(data[current], options);
                    }

                    drawChart();

                    button.onclick = function () {
                        current = 1 - current;
                        drawChart();
                    }
                }
            </script>


        </div>
    </div>

    {#    ######################################   Regression Graph   ##########################################}
    <hr>
    <h1 class="display-6">Regression Analysis</h1>
    <div class="row">

        {#    ooooooooooooooooooooooooooo  Linear Regression  ooooooooooooooooooooooooooooooooo#}
        <div class="col">
            <p class="graph_heading">Linear Model</p>
            {#                    --------------------Graph----------------#}
            <div class="row">
                <div class="col">
                    <div id="linear_div"></div>

                    <script type="text/javascript">
                        google.charts.load("current", {packages: ["corechart"]});
                        google.charts.setOnLoadCallback(drawChart);

                        function drawChart() {
                            var data = google.visualization.arrayToDataTable([
                                ['Storage Duration', 'Deviation'],
                                {% for duration in setting.duration.all %}
                                    {% deviation_tot setting duration as dev_tot %}
                                        {% if dev_tot %}
                                    [{{ duration.seconds }}, {% deviation_tot setting duration %}],
                                    {% endif %}
                                {% endfor %}
                                {#[ 8,      12],#}
                                {#[ 4,      5.5],#}
                                {#[ 11,     14],#}
                                {#[ 4,      5],#}
                                {#[ 3,      3.5],#}
                                {#[ 6.5,    7]#}
                            ]);

                            var options = {
                                title: 'Parameter deviation at selected storage durations',
                                vAxis: {title: "Deviation"},
                                hAxis: {title: "Storage duration (seconds)"},
                                legend: 'top',
                                crosshair: {trigger: 'both', orientation: 'both'},
                                trendlines: {
                                    0: {
                                        type: 'linear',
                                        {#degree: 3,#}
                                        visibleInLegend: true,
                                    }
                                }
                            };

                            var chart = new google.visualization.ScatterChart(document.getElementById('linear_div'));
                            chart.draw(data, options);
                        }
                    </script>
                </div>
            </div>
            {#                      --------------------Statistics--------------#}
            <div class="row">
                <div class="col">
                    <br>
                    <table>

                        <tr>
                            <td>
                                R2
                            </td>
                            <td>
                                {{ r_squared_lin | floatformat:4 }}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                R2 adjusted
                            </td>
                            <td>
                                {{ r_squared_lin_adj  | floatformat:4 }}
                            </td>
                        </tr>
                        <tr>
                            <td>Regression equation: <br></td>
                        </tr>
                        <tr>
                            <td>{{ eq_model_lin }} <br></td>
                        </tr>
                        <tr>
                            <td>
                                <hr>
                                y...Testresult (dependent variable) <br>
                                x1...Storage Duration (independent variable)
                            </td>
                        </tr>
                    </table>


                </div>
            </div>
            {#                 ------------- Button-Extended Statictics ----------------#}
            <br>
            <div class="row">
                <div class="col">


                    <!-- Button trigger modal -->
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#linearModal">
                        Extended Statistics
                    </button>

                    <!-- Modal -->
                    <div class="modal fade" id="linearModal" tabindex="-1" aria-labelledby="linearModalLabel"
                         aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="linearModalLabel">Stability study
                                        "{{ setting.name }}" <br> Extended Statistics - Linear model</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <pre style="font-family: monospace, monospace">{{ statistics_extended_abs_lin|safe }}</pre>
                                </div>
                                <div class="modal-footer">
                                    <a href="javascript:window.print()" class="bi bi-printer print"></a>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
            {#                        -------------------Calculator---------------#}
            <hr>
            <div class="row">
                <div class="col">

                    {#    TODO: Check if input is in seconds#}

                    <form>
                        {% csrf_token %}
                        <div class="form-row align-items-center">
                            <div class="col-auto">
                                <label class="sr-only" for="inlineFormInput">Seconds</label>
                                <input type="text" class="form-control mb-2" id="inlineFormInput"
                                       placeholder="Insert storage time in seconds">
                            </div>
                            <div class="col-auto">
                                <button id="button_calc" value="here goes result" onclick="calcValue()"
                                        class="btn btn-outline-primary">Calculate
                                </button>
                            </div>
                        </div>
                    </form>
                    <div class="row">
                        <div class="col">
                    <span class="calc_result">The estimated Result at that storage time is: <p
                            id="calc_result"></p></span>
                        </div>
                    </div>
                    <script>
                        function calcValue() {
                            var x = document.getElementById("calc_input").value;
                            var y = {{ intercept }} +x * {{ slope }};
                            document.getElementById("calc_result").innerHTML = y;
                        }
                    </script>

                </div>
            </div>
        </div>
        {#    ooooooooooooooooooooooooooo  Linear Regression Log transformed  ooooooooooooooooooooooooooooooooo#}
{#       FIXME: Does not seem to be log#}
        <div class="col">
            <p class="graph_heading">Log transformed model</p>
            {#                    --------------------Graph----------------#}
            <div class="row">
                <div class="col">
                    <div id="log_div"></div>

                    <script type="text/javascript">
                        google.charts.load("current", {packages: ["corechart"]});
                        google.charts.setOnLoadCallback(drawChart);

                        function drawChart() {
                            var data = google.visualization.arrayToDataTable([
                                ['Storage Duration', 'Deviation'],
                                {% for duration in setting.duration.all %}
                                    {% deviation_tot setting duration as dev_tot %}
                                        {% if dev_tot %}
                                    [{{ duration.seconds }}, {% deviation_tot setting duration %}],
                                {% endif %}
                                {% endfor %}
                            ]);

                            var options = {
                                title: 'Parameter deviation at selected storage durations',
                                vAxis: {title: "Deviation"},
                                hAxis: {title: "Storage duration - log(seconds)", logscale: true},
                                legend: 'top',
                                crosshair: {trigger: 'both', orientation: 'both'},
                                trendlines: {
                                    0: {
                                        type: 'linear',
                                        {#degree: 3,#}
                                        visibleInLegend: true,
                                    }
                                }
                            };

                            var chart = new google.visualization.ScatterChart(document.getElementById('log_div'));
                            chart.draw(data, options);
                        }
                    </script>
                </div>
            </div>
            {#                      --------------------Statistics--------------#}
            <div class="row">
                <div class="col">
                    <br>
                    <table>

                        <tr>
                            <td>
                                R2
                            </td>
                            <td>
                                {{ r_squared_log | floatformat:4 }}
                            </td>
                        </tr>
                        <tr>
                            <td>
                                R2 adjusted
                            </td>
                            <td>
                                {{ r_squared_log_adj  | floatformat:4 }}
                            </td>
                        </tr>
                        <tr>
                            <td>Regression equation: <br></td>
                        </tr>
                        <tr>
                            <td><br></td>
                        </tr>
                        <tr>
                            <td>
                                <hr>
                                y...Testresult (dependent variable) <br>
                                x1...Storage Duration (independent variable)
                            </td>
                        </tr>
                    </table>


                </div>
            </div>
            {#                 ------------- Button-Extended Statictics ----------------#}
            <br>
            <div class="row">
                <div class="col">


                    <!-- Button trigger modal -->

                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#logModal">
                        Extended Statistics
                    </button>

                    <!-- Modal -->
                    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel"
                         aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="logModalLabel">Stability study
                                        "{{ setting.name }}" <br> Extended Statistics - Logarithmic model</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <pre style="font-family: monospace, monospace">{{ statistics_extended_log|safe }}</pre>
                                </div>
                                <div class="modal-footer">
                                    <a href="javascript:window.print()" class="bi bi-printer print"></a>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            {#                        -------------------Calculator---------------#}
            <hr>
            <div class="row">
                <div class="col">

                    <form>
                        {% csrf_token %}
                        <div class="form-row align-items-center">
                            <div class="col-auto">
                                <label class="sr-only" for="inlineFormInput">Seconds</label>
                                <input type="text" class="form-control mb-2" id="inlineFormInput"
                                       placeholder="Insert storage time in seconds">
                            </div>
                            <div class="col-auto">
                                <button id="button_calc" value="here goes result" onclick="calcValue()"
                                        class="btn btn-outline-primary">Calculate
                                </button>
                            </div>
                        </div>
                    </form>
                    <div class="row">
                        <div class="col">
                    <span class="calc_result">The estimated Result at that storage time is: <p
                            id="calc_result"></p></span>
                        </div>
                    </div>
                    <script>
                        function calcValue() {
                            var x = document.getElementById("calc_input").value;
                            var y = {{ intercept }} +x * {{ slope }};
                            document.getElementById("calc_result").innerHTML = y;
                        }
                    </script>
                </div>
            </div>
        </div>

        <hr>

        <div class="row">
            {#    oooooooooooooooooooooooooooooooooooo  Polynomal Regression 2rd degree  oooooooooooooooooooooooooooooo#}
            <div class="col">
                <p class="graph_heading">Polynomial Model 2Â°</p>
                <div class="row">
                    <div class="col">
                        <div id="poly2_div"></div>

                        <script type="text/javascript">
                            google.charts.load("current", {packages: ["corechart"]});
                            google.charts.setOnLoadCallback(drawChart);

                            function drawChart() {
                                var data = google.visualization.arrayToDataTable([
                                    ['Storage Duration', 'Deviation'],
                                    {% for duration in setting.duration.all %}
                                        {% deviation_tot setting duration as dev_tot %}
                                        {% if dev_tot %}
                                        [{{ duration.seconds }}, {% deviation_tot setting duration %}],
                                    {% endif %}
                                    {% endfor %}
                                    {#[ 8,      12],#}
                                    {#[ 4,      5.5],#}
                                    {#[ 11,     14],#}
                                    {#[ 4,      5],#}
                                    {#[ 3,      3.5],#}
                                    {#[ 6.5,    7]#}
                                ]);

                                var options = {
                                    title: 'Parameter deviation at selected storage durations',
                                    vAxis: {title: "Deviation"},
                                    hAxis: {title: "Storage duration (seconds)"},
                                    legend: 'top',
                                    crosshair: {trigger: 'both', orientation: 'both'},
                                    trendlines: {
                                        0: {
                                            type: 'polynomial',
                                            degree: 2,
                                            visibleInLegend: true,
                                        }
                                    }
                                };

                                var chart = new google.visualization.ScatterChart(document.getElementById('poly2_div'));
                                chart.draw(data, options);
                            }
                        </script>
                    </div>
                </div>
                {#                      --------------------Statistics--------------#}
                <div class="row">
                    <div class="col">
                        <table>
                            <tr>
                                <td>R2</td>
                                <td>{{ r_squared_poly2 |floatformat:4 }}</td>
                            </tr>
                            <tr>
                                <td>
                                    Regression equation
                                </td>

                            </tr>
                            <tr>
                                <td>
                                    {{ eq_model_poly2 }}
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <hr>
                                    y...Testresult (dependent variable) <br>
                                    x1...Timepoint (independent variable) <br>
                                </td>
                            </tr>
                        </table>

                    </div>
                </div>

                {#                        -------------------Calculator---------------#}
                <hr>
                Calculate individual values based on the regression equation


                <form>
                    {% csrf_token %}
                    <div class="form-row align-items-center">
                        <div class="col-auto">
                            <label class="sr-only" for="inlineFormInput">Seconds</label>
                            <input type="text" class="form-control mb-2" id="inlineFormInput"
                                   placeholder="Insert storage time in seconds">
                        </div>
                        <div class="col-auto">
                            <button id="button_calc" value="here goes result" onclick="calcValue()"
                                    class="btn btn-outline-primary">Calculate
                            </button>
                        </div>
                    </div>
                </form>
                <div class="row">
                    <div class="col">
                    <span class="calc_result">The estimated Result at that storage time is: <p
                            id="calc_result"></p></span>
                    </div>
                </div>
                <script>
                    function calcValue() {
                        var x = document.getElementById("calc_input").value;
                        var y = {{ intercept }} +x * {{ slope }};
                        document.getElementById("calc_result").innerHTML = y;
                    }
                </script>


            </div>


            {#     oooooooooooooooooooooooooooooooooooooo Polynomal Regression 3rd degree  ooooooooooooooooooooooooooooooooooo#}


            <div class="col">
                <p class="graph_heading">Ploynomial Model 3Â° (Cubic)</p>
                <div class="row">
                    <div class="col">
                        <div id="poly3_div"></div>

                        <script type="text/javascript">
                            google.charts.load("current", {packages: ["corechart"]});
                            google.charts.setOnLoadCallback(drawChart);

                            function drawChart() {
                                var data = google.visualization.arrayToDataTable([
                                    ['Storage Duration', 'Deviation'],
                                    {% for duration in setting.duration.all %}
                                        {% deviation_tot setting duration as dev_tot %}
                                        {% if dev_tot %}
                                        [{{ duration.seconds }}, {% deviation_tot setting duration %}],
                                        {% endif %}
                                    {% endfor %}
{#                                    [ 8,      12],#}
{#                                    [ 4,      5.5],#}
{#                                    [ 11,     14],#}
{#                                    [ 4,      5],#}
{#                                    [ 3,      3.5],#}
{#                                    [ 6.5,    7]#}
{#                                        [0, 0.0],#}
{#                                        [3600, 44.52],#}
{#                                        [259200, 70.33],#}
{#                                        [12960000, 90],#}

                                ]);

                                var options = {
                                    title: 'Parameter deviation at selected storage durations',
                                    vAxis: {title: "Deviation"},
                                    hAxis: {title: "Storage duration (seconds)"},
                                    legend: 'top',
                                    crosshair: {trigger: 'both', orientation: 'both'},
                                    trendlines: {
                                        0: {
                                            type: 'polynomial',
                                            degree: 3,
                                            visibleInLegend: true,
                                            interpolateNulls: true,
                                        }
                                    }
                                };

                                var chart = new google.visualization.ScatterChart(document.getElementById('poly3_div'));
                                chart.draw(data, options);
                            }
                        </script>
                    </div>
                </div>
                {#                      --------------------Statistics--------------#}
                <div class="row">
                    <div class="col">
                        <table>
                            <tr>
                                <td>R2</td>
                                <td>{{ r_squared_poly3 |floatformat:4 }}</td>
                            </tr>
                            <tr>
                                <td>
                                    Regression equation
                                </td>

                            </tr>
                            <tr>
                                <td>
                                    {{ eq_model_poly3 }}
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <hr>
                                    y...Testresult (dependent variable) <br>
                                    x1...Timepoint (independent variable) <br>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                {#                        -------------------Calculator---------------#}
                <hr>
                Calculate individual values based on the regression equation

                <form>
                    {% csrf_token %}
                    <div class="form-row align-items-center">
                        <div class="col-auto">
                            <label class="sr-only" for="inlineFormInput">Seconds</label>
                            <input type="text" class="form-control mb-2" id="inlineFormInput"
                                   placeholder="Insert storage time in seconds">
                        </div>
                        <div class="col-auto">
                            <button id="button_calc" value="here goes result" onclick="calcValue()"
                                    class="btn btn-outline-primary">Calculate
                            </button>
                        </div>
                    </div>
                </form>
                <div class="row">
                    <div class="col">
                    <span class="calc_result">The estimated Result at that storage time is: <p
                            id="calc_result"></p></span>
                    </div>
                </div>
                <script>
                    function calcValue() {
                        var x = document.getElementById("calc_input").value;
                        var y = {{ intercept }} +x * {{ slope }};
                        document.getElementById("calc_result").innerHTML = y;
                    }
                </script>
            </div>
        </div>
    </div>



    {#    ---------------------------------RESULT TABLE------------------------------#}
    <h1 class="display-6">Single results</h1>
    <div class="row">
        <div class="col">
            <table class="table table-hover">
                <thead class="th_results">
                <tr>
                    <th scope="col">Subject</th>
                    {% for duration in setting.duration.all %}
                        <th>{{ duration.seconds | human_readable_seconds }}</th>
                    {% endfor %}

                </tr>
                </thead>
                <tbody>
                <tr class="total_results">
                    <td>No of subjects: {{ subjects.count }}</td>
                    {% for duration in setting.duration.all %}
                        <td>
                            <br>
                            AVG Total: {% average_tot setting duration %} {{ setting.parameter.unit }}<br>
                            SD Total: {% stdv_tot setting duration %} <br>
                            CV Total: {% cv_tot setting duration %} %<br>
                            Dev Total: {% deviation_tot setting duration %} %
                        </td>
                    {% endfor %}
                </tr>
                {% for subject in subjects %}

                    <tr>
                        <th scope="row" rowspan="2">{{ subject }}</th>
                        {% for duration in setting.duration.all %}
                            <td>

{#                                {% for replicate in subject.replicate_set.all %}#}
                                    {% for result in subject.result_set.all %}
                                        {% if result.duration == duration %}
                                            {% if result.setting == setting %}
{#                                            {% if result.subject == subject %}#}
{#                                                {% if not result.value %}#}
                                                    {# FIXME: Does not work                      'No results entered'#}
{#                                                {% else %}#}
                                                    {{ result.value }} {{ setting.parameter.unit }} <br>
                                                {% endif %}
                                            {% endif %}
{##}
{#                                        {% endif %}#}
{#                                    {% endfor %}#}
                                {% endfor %}

                            </td>
                        {% endfor %}
                    </tr>
                    <tr>

                        {% for duration in setting.duration.all %}
                            <td>
{#                            FIXME: Average takes in all values of subject X disregarding the setting#}
                                AVG: {% average subject duration setting %} {{ setting.parameter.unit }}<br>
                                SD: {% stdv subject duration setting %}<br>
                                CV: {% cv subject duration setting %}%<br>
                                DEV: {% deviation subject duration setting %}%<br>
                            </td>
                        {% endfor %}

                        <td></td>
                    </tr>
                {% endfor %}

                </tbody>


            </table>


        </div>

    </div>



{% endblock %}