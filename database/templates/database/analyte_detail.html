{% extends "base.html" %}
{% load template_filters %}
{% load i18n %}
{% load static %}
{#{% load filters %}#}


{% block title %}Search Stability Database{% endblock %}

{% block content %}

    {#    {% if "Blood" in analyte.specimen.name %}#}
    <h4 class="display-5">{{ analyte.name }} {% if analyte.details %} - <i>{{ analyte.details }}</i>{% endif %}
        </h4>
    {#    TODO: Name does not work #}

    {#    <div id="tabs" hx-get="{% url 'analyte_blood' %}" hx-trigger="load delay:100ms" hx-target="#tabs" hx-swap="innerHTML"></div>#}




    <div class="card">
            <div class="card-header">
                <h5 class="card-title">Network Settings</h5>

    <ul class="nav nav-tabs card-header-tabs" id="specimen_tab" role="tablist">
    {% for a_s in analyte.analyte_specimen.all %}
    <li class="nav-item" role="presentation">
        <a class="nav-link{% if forloop.first %} active{% endif %}"
           id="tab-{{ a_s.specimen.sg_id }}"
           data-bs-toggle="tab"
           href="#pane-{{ a_s.specimen.sg_id }}"
           role="tab"
           aria-controls="pane-{{ a_s.specimen.sg_id }}"
           aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
           {{ a_s.specimen.name }}
        </a>
    </li>
{% endfor %}
    </ul>
            </div>
<div class="card-body tab-content">
<div class="tab-content" id="specimen_tabContent">
    {% for a_s in analyte.analyte_specimen.all %}
        <div class="tab-pane fade{% if forloop.first %} show active{% endif %}"
             id="pane-{{ a_s.specimen.sg_id }}"
             role="tabpanel"
             aria-labelledby="tab-{{ a_s.specimen.sg_id }}">
{% if a_s.loinc_num %}
                            <div class="container" id="loinc">
                                <div class="card-header">
                                    <div class="col-12">
                                        <h4>LOINC
                                            Number: <a href="https://loinc.org/{{ a_s.loinc_num }}"
                                                       target="_blank"> {{ a_s.loinc_num }}</a>
                                        </h4>

                                    </div>
                                </div>
                            </div>
                        {% endif %}
        {% if a_s.tube_recomm.all or a_s.tube_possible.all or a_s.tube_maybeposs.all or a_s.tube_not.all %}
                        <div class="container" id="blood_collection_tubes">
                            <div class="card-header">
                                <h4>Specimen collection tubes</h4>
                            </div>
                            <div class="card-body row">

                                {% if a_s.tube_recomm.all %}
                                    <div class="col-md-3 tubetype">
                                        <h5>Recommended</h5>
                                        {% for tube in a_s.tube_recomm.all %}
                                            - {{ tube.name }} <br>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                {% if a_s.tube_possible.all %}
                                    <div class="col-md-3 tubetype">
                                        <h5>Possible</h5>
                                        {% for tube in a_s.tube_possible.all %}
                                            - {{ tube.name }} <br>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if a_s.tube_maybeposs.all %}
                                    <div class="col-md-3 tubetype">
                                        <h5>Eventually possible</h5>
                                        {% for tube in a_s.tube_maybeposs.all %}
                                            - {{ tube.name }} <br>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if a_s.tube_not.all %}
                                    <div class="col-md-3 tubetype">
                                        <h5>NOT recommended</h5>
                                        {% for tube in a_s.tube_not.all %}
                                            - {{ tube.name }} <br>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
        {% if a_s.stability|is_not_empty_m2m_field_or:"eq_type,b0,exp_a" %}
                                <div class="card-header">
                                    <h4>Stability Equations</h4>

                                </div>
                                <div class="card-body row">

                                    {% for stab in a_s.stability.all %}
                                        {{ stab.exp_a }}
                                        {% if stab.eq_type %}
                                            <div class="row">
                                                <div class="col">

                                                    <h6><u>Storage Temperature:</u> {{ stab.get_temperature_display }}
                                                    </h6>
                                                    <h6><u>Regression:</u>
                                                        {{ stab.get_eq_type_display }} <br>
                                                        {% if stab.eq_type == "1" %}
                                                            Bias = {{ stab.b0 }} + {{ stab.b1 }} * Time
                                                        {% elif stab.eq_type == "2" %}
                                                            Bias = {{ stab.b0 }} + {{ stab.b1 }} * Time +
                                                            {{ stab.b2 }} * Time^2
                                                        {% elif stab.eq_type == "3" %}
                                                            Bias = {{ stab.b0 }} + {{ stab.b1 }} * Time +
                                                            {{ stab.b2 }} * Time^2 + {{ stab.b3 }} * Time^3
                                                            {% elif stab.eq_type == "4" %}
                                                            PD% = {{ stab.exp_a }} * {{ stab.exp_b }}^Storage hours
                                                        {% endif %}
                                                    </h6>
                                                </div>
                                                <div class="col">

                                                    <img src="{{ graph|dict_key:stab.pk }}" alt=""/>

                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <u>References</u>
                                                    {% for lit in stab.stab_literature.all %}

                                                        <!-- Button trigger modal -->
                                                        <a href="#" data-bs-toggle="modal"
                                                           data-bs-target="#literatureModal{{ lit.lit_no }}">
                                                            #{{ lit.lit_no }}
                                                        </a> |

                                                        <!-- Modal -->
                                                        <div class="modal fade text-black"
                                                             id="literatureModal{{ lit.lit_no }}" tabindex="-1"
                                                             aria-labelledby="literatureModalLabel"
                                                             aria-hidden="true">
                                                            <div class="modal-dialog">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title"
                                                                            id="literatureModalLabel">Reference
                                                                            #{{ lit.lit_no }}</h5>
                                                                        <button type="button" class="btn-close"
                                                                                data-bs-dismiss="modal"
                                                                                aria-label="Close"></button>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        {{ lit.authors }}. {{ lit.title }}. {{ lit_source }}
                                                                        <br>
                                                                        DOI: <a
                                                                            href="https://doi.org/{{ lit.doi }}">{{ lit.doi }}</a>
                                                                        <br>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                                {% if stab.stabilizer %}
                                                    <div class="col">
                                                        Stabilizer: {{ stab.stabilizer }}
                                                    </div>
                                                {% endif %}
                                                {% if stab.stab_platform %}
                                                    <div class="col">
                                                        Platform: {{ stab.stab_platform }}
                                                    </div>
                                                {% endif %}
                                                {% if stab.stab_analyt_method %}
                                                    <div class="col">
                                                        Analyt. Method: {{ stab.stab_analyt_method }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            {% if stab.stab_comment %}
                                                <div class="row">
                                                    <div class="col">
                                                        Comment: {{ stab.stab_comment }}
                                                    </div>
                                                </div>
                                            {% endif %}
                                            <hr>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if a_s.stability|is_not_empty_m2m_field_or:"abs_min,abs_max" %}
                                <div class="card-header">
                                    <h4>Absolute Stabilities</h4>
                                </div>
                                <div class="card-body row">
                                    {% for stab in a_s.stability.all %}
                                        <div class="row stabilities-abs">
                                            <div class="col-md-3">
                                                <h6>{{ stab.get_temperature_display }}</h6>
                                                {% if stab.abs_min_prefix %}
                                                    {{ stab.abs_min_prefix }}
                                                {% endif %}
                                                {% if stab.abs_min %}
                                                    {{ stab.abs_min|convert_time|get_time_value|floatformat:2 }}
                                                    {{ stab.abs_min|convert_time|get_time_unit }}
                                                {% endif %}
                                                {% if stab.abs_max_prefix %}
                                                    {{ stab.abs_max_prefix }}
                                                {% endif %}
                                                {% if stab.abs_max %}
                                                    -
                                                    {{ stab.abs_max|convert_time|get_time_value|floatformat:2 }}
                                                    {{ stab.abs_max|convert_time|get_time_unit }}
                                                {% endif %}
                                            </div>
                                            <div class="col-md-3">
                                                {% if stab.stab_comment %}
                                                    <p><u>Comment:</u> <br>{{ stab.stab_comment }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-3">
                                                <u>References:</u> <br>
                                                {% for lit in stab.stab_literature.all %}

                                                    <!-- Button trigger modal -->
                                                    <a href="#" data-bs-toggle="modal"
                                                       data-bs-target="#literatureModal{{ lit.lit_no }}">
                                                        #{{ lit.lit_no }}
                                                    </a> |

                                                    <!-- Modal -->
                                                    <div class="modal fade text-black"
                                                         id="literatureModal{{ lit.lit_no }}" tabindex="-1"
                                                         aria-labelledby="literatureModalLabel" aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title"
                                                                        id="literatureModalLabel">Reference
                                                                        #{{ lit.lit_no }}</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"
                                                                            aria-label="Close"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    {{ lit.authors }}. {{ lit.title }}. {{ lit_source }}
                                                                    <br>
                                                                    DOI: <a
                                                                        href="https://doi.org/{{ lit.doi }}">{{ lit.doi }}</a>
                                                                    <br>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                </div>
                            {% endif %}
        </div>
    {% endfor %}
</div>
</div>

{#            {% for a_s in analyte.analyte_specimen.all %}#}
{#                <li class="nav-item" role="presentation">#}
{#                    <a class="nav-link{% if forloop.first %} active{% endif %}"#}
{#                       id="tab-{{ a_s.specimen.sg_id }}"#}
{#                       data-bs-toggle="tab"#}
{#                       href="#pane-{{ a_s.specimen.sg_id }}"#}
{#                       role="tab"#}
{#                       aria-controls="pane-{{ a_s.specimen.sg_id }}"#}
{#                       aria-current="{% if forloop.first %}true{% else %}false{% endif %}">{{ a_s.specimen.name }}</a>#}
{#                </li>#}
{#            {% endfor %}#}
{#        </ul>#}
{#        <div class="tab-content" id="specimen_tabContent">#}
{#            {% for a_s in analyte.analyte_specimen.all %}#}
{#                <div class="tab-pane fade{% if forloop.first %} show active {% endif %}"#}
{#                     id="pane-{{ a_s.specimen.sg_id }}"#}
{#                     role="tabpanel"#}
{#                     aria-labelledby="tab-{{ a_s.specimen.sg_id }}">#}
{#                        {% if a_s.loinc_num %}#}
{#                            <div class="container" id="loinc">#}
{#                                <div class="card-header">#}
{#                                    <div class="col-12">#}
{#                                        <h4>LOINC#}
{#                                            Number: <a href="https://loinc.org/{{ a_s.loinc_num }}"#}
{#                                                       target="_blank"> {{ a_s.loinc_num }}</a>#}
{#                                        </h4>#}
{##}
{#                                    </div>#}
{#                                </div>#}
{#                            </div>#}
{#    {% endif %}#}
{#    {% endfor %}#}


{% endblock %}


